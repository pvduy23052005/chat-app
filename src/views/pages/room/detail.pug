extends ../../layout/default.pug
include ../../mixins/box-alert.pug

block main 
  .container.my-4
    .row.justify-content-center
      .col-12.col-lg-8

        //- Alerts
        if success
          +box-success(success)
        if error
          +box-error(error)

        //- Check superAdmin
        - let isSuperAdmin = false
        each member in room.members
          - const memberId = member.user_id._id.toString()
          if memberId === user.id && member.role === "superAdmin"
            - isSuperAdmin = true

        //- Room Header
        .card.mb-4
          .card-body
            .d-flex.align-items-center.gap-3
              .room-avatar
                img(src=(room.avatar ? room.avatar : "/images/default-avatar.webp") alt=room.title)

              .flex-grow-1
                form(
                  id="form-edit-room" 
                  action=`/room/edit/${room._id}` 
                  method="POST"
                )
                  input.form-control.input-title-edit(
                    type="text" 
                    name="title" 
                    value=room.title
                    required
                    placeholder="Tên phòng"
                  )

                  p.text-muted.mb-0.mt-1
                    i.fas.fa-user.me-2
                    span #{room.members.length} thành viên

              if isSuperAdmin
                .action-buttons.d-flex.gap-2
                  button.btn.btn-sm.btn-outline-primary(
                    type="submit" 
                    form="form-edit-room" 
                    title="Lưu thay đổi"
                  )
                    i.fas.fa-save 
                  button.btn.btn-sm.btn-outline-success#btn-add-member(type="button" title="Thêm thành viên")
                    i.fas.fa-user-plus
                  form(
                    action=`/room/delete/${room._id}` 
                    method="POST" 
                    onsubmit="return confirm('Bạn có chắc muốn xóa nhóm này?')" 
                    style="display: inline;"
                  )
                    button.btn.btn-sm.btn-outline-danger(type="submit" title="Xóa nhóm")
                      i.fas.fa-trash

        //- Members List
        .card
          .card-header.d-flex.justify-content-between.align-items-center
            h5.mb-0
              i.fas.fa-users.me-2
              | Danh sách thành viên

          .card-body.p-0
            if room.members && room.members.length > 0
              .list-group.list-group-flush
                each member in room.members
                  - const userId = member.user_id._id.toString()
                  - const isCurrentUser = userId === user.id

                  .list-group-item
                    .d-flex.align-items-center.gap-3
                      .member-avatar
                        img(
                          src=(member.user_id.avatar || "/images/default-avatar.webp")
                          alt=member.user_id.fullName
                        )

                      .flex-grow-1
                        .d-flex.align-items-center.gap-2.mb-1
                          strong= member.user_id.fullName

                          if isCurrentUser
                            span.badge.bg-secondary Bạn

                          if member.role === "superAdmin"
                            span.badge.bg-primary
                              i.fas.fa-crown.me-1
                              | Quản trị viên
                          else if member.role === "admin"
                            span.badge.bg-success
                              i.fas.fa-shield-alt.me-1
                              | Admin

                        small.text-muted= member.user_id.email

                      if isSuperAdmin && !isCurrentUser
                        form(
                          action="/room/remove-member" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit=`return confirm('Bạn có chắc muốn xóa "${member.user_id.fullName}" khỏi nhóm?')`
                        )
                          input(type="hidden" name="roomId" value=room._id)
                          input(type="hidden" name="memberId" value=userId)
                          button.btn.btn-sm.btn-outline-danger(type="submit" title="Xóa khỏi nhóm")
                            i.fas.fa-user-times
            else
              .text-center.py-5
                i.fas.fa-users.fa-3x.text-muted.mb-3
                p.text-muted Chưa có thành viên nào

      //- Sidebar Add Member (bên phải)
      .col-12.col-lg-4
        .add-member-sidebar#add-member-sidebar
          .card
            .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
              h5.mb-0
                i.fas.fa-user-plus.me-2
                | Thêm thành viên
              button.btn.btn-sm.btn-close.btn-close-white#btn-close-sidebar(type="button")

            .card-body
              form(action=`/room/add-member/${room._id}` method="POST")
                input(type="hidden" name="roomId" value=room._id)

                if friends && friends.length > 0
                  .friends-list
                    each friend in friends
                      .box-user-select.mb-2
                        input(
                          type="checkbox" 
                          name="memberIds" 
                          value=friend._id 
                          id=`friend-${friend._id}`
                        )
                        label(for=`friend-${friend._id}`)
                          .inner-avatar
                            img(
                              src=(friend.avatar ? friend.avatar : "/images/default-avatar.webp")
                              alt=friend.fullName
                            )
                          .inner-name #{friend.fullName}

                  .mt-3
                    button.btn.btn-primary.w-100(type="submit")
                      i.fas.fa-plus.me-2
                      | Thêm vào nhóm
                else
                  .alert.alert-warning
                    i.fas.fa-exclamation-triangle.me-2
                    | Không có bạn bè để thêm

  //- JavaScript
  script.
    const btnAddMember = document.getElementById('btn-add-member');
    const btnCloseSidebar = document.getElementById('btn-close-sidebar');
    const sidebar = document.getElementById('add-member-sidebar');

    if (btnAddMember) {
      btnAddMember.addEventListener('click', function() {
        sidebar.style.display = 'block';
        sidebar.style.animation = 'slideInRight 0.3s ease';
      });
    }

    if (btnCloseSidebar) {
      btnCloseSidebar.addEventListener('click', function() {
        sidebar.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
          sidebar.style.display = 'none';
        }, 300);
      });
    }